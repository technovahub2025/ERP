<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Workspace — Tasks & Activity</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<!-- SheetJS for Excel/CSV parsing -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<style>
  :root{
    --brand:#6c2bd9;      /* Odoo-like purple */
    --brand-600:#5a23bf;
    --bg:#f6f7fb;
    --card:#ffffff;
    --muted:#6b7280;
    --text:#101828;
    --border:#e5e7eb;
    --success:#22c55e;
    --warn:#f59e0b;
    --danger:#ef4444;
    --danger-600:#dc2626;
    --shadow: 0 4px 14px rgba(20,22,33,.07);
    --radius: 14px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,Apple Color Emoji,Segoe UI Emoji;
    color:var(--text);
    background:var(--bg);
  }
  /* Topbar */
  .topbar{
    position:sticky; top:0; z-index:30;
    height:64px; background:var(--brand); color:#fff;
    display:flex; align-items:center; padding:0 18px; gap:14px;
    box-shadow:var(--shadow);
  }
  .logo{display:flex; align-items:center; gap:10px; font-weight:700}
  .logo .dot{width:14px;height:14px;border-radius:50%;background:#fff;opacity:.85}
  .top-search{
    flex:1; display:flex; align-items:center; gap:8px;
    background:rgba(255,255,255,.16); border-radius:999px; padding:8px 12px;
  }
  .top-search input{
    border:0;background:transparent;outline:0;color:#fff; width:100%;
  }
  .top-actions{display:flex;align-items:center;gap:12px}
  .icon-btn{
    background:rgba(255,255,255,.16); border:1px solid rgba(255,255,255,.2);
    color:#fff; height:36px; padding:0 12px; border-radius:10px; cursor:pointer;
  }
  /* Layout */
  .wrap{display:grid; grid-template-columns: 250px 1fr; min-height:calc(100vh - 64px)}
  .sidebar{
    background:#fff; border-right:1px solid var(--border); padding:18px; position:sticky; top:64px; height:calc(100vh - 64px);
  }
  .side-title{font-size:13px; color:var(--muted); margin:10px 0}
  .nav{display:flex; flex-direction:column; gap:6px}
  .nav a{
    display:flex; align-items:center; gap:10px; text-decoration:none; color:#111827;
    padding:10px 12px; border-radius:10px;
  }
  .nav a.active,.nav a:hover{background: #f3e8ff; color:var(--brand)}
  .content{padding:22px; display:flex; flex-direction:column; gap:18px}
  /* Cards & grids */
  .grid{display:grid; gap:18px}
  .grid-4{grid-template-columns: repeat(4, minmax(0,1fr))}
  .grid-3{grid-template-columns: repeat(3, minmax(0,1fr))}
  @media (max-width:1100px){ .grid-4{grid-template-columns:repeat(2,1fr)} .grid-3{grid-template-columns:repeat(2,1fr)} }
  @media (max-width:700px){ .wrap{grid-template-columns:1fr} .sidebar{position:static;height:auto} .grid-4,.grid-3{grid-template-columns:1fr} }
  .card{
    background:var(--card); border:1px solid var(--border); border-radius:var(--radius);
    box-shadow:var(--shadow); padding:16px;
  }
  .card h3{margin:4px 0 12px; font-size:16px}
  .muted{color:var(--muted)}
  .stat{
    display:flex; align-items:center; justify-content:space-between;
    padding:10px 4px;
  }
  .stat .n{font-size:28px; font-weight:700}
  .chip{
    display:inline-flex; align-items:center; gap:6px;
    padding:6px 10px; border-radius:999px; font-size:12px; border:1px solid var(--border);
    background:#fafafa;
  }
  .chip.success{color:var(--success); border-color:#c6f6d5; background:#f0fdf4}
  .chip.warn{color:var(--warn); border-color:#fde68a; background:#fffbeb}
  .chip.danger{color:var(--danger); border-color:#fecaca; background:#fef2f2}
  /* Buttons */
  .btn{
    border:1px solid var(--border); background:#fff; color:#111827; border-radius:10px;
    padding:10px 14px; cursor:pointer;
  }
  .btn.small{padding:6px 10px; font-size:12px; border-radius:8px}
  .btn.primary{background:var(--brand); color:#fff; border-color:transparent}
  .btn.primary:hover{background:var(--brand-600)}
  .btn.danger{background:var(--danger); color:#fff; border-color:transparent}
  .btn.danger:hover{background:var(--danger-600)}
  /* Boards */
  .toolbar{display:flex; align-items:center; gap:10px; justify-content:space-between; flex-wrap:wrap; margin-bottom:6px}
  select,input[type="date"],input[type="text"],input[type="number"],input[type="color"],textarea{
    border:1px solid var(--border); background:#fff; padding:9px 10px; border-radius:10px; outline:none;
  }
  .employee-card{
    border:1px solid var(--border); border-radius:14px; padding:14px; display:flex; flex-direction:column; gap:10px; background:#fff
  }
  .emp-head{display:flex; align-items:center; gap:10px}
  .emp-head .spacer{flex:1}
  .avatar{width:40px;height:40px;border-radius:50%;display:grid;place-items:center;color:#fff;font-weight:700}
  .progress-wrap{background:#f1f5f9;height:8px;border-radius:999px;overflow:hidden}
  .progress{height:8px;background:var(--brand);width:0}
  .task-row{
    border:1px solid var(--border); border-radius:12px; padding:10px; display:flex; align-items:center; gap:10px; justify-content:space-between;
  }
  .task-meta{display:flex; align-items:center; gap:10px}
  .badge{font-size:11px; padding:3px 8px; border-radius:999px; background:#eef2ff; color:#3730a3}
  .pri-HIGH{background:#fee2e2;color:#991b1b}
  .pri-MEDIUM{background:#fffbeb;color:#92400e}
  .pri-LOW{background:#ecfeff;color:#155e75}
  .status-select{border:1px solid var(--border); background:#fff; border-radius:8px; padding:6px 8px}
  /* Timeline */
  .timeline{display:flex; flex-direction:column; gap:10px; max-height:320px; overflow:auto}
  .tl-item{display:flex; gap:10px}
  .dotline{width:10px; display:flex; flex-direction:column; align-items:center}
  .dotline::before{content:""; width:10px;height:10px;border-radius:50%;background:var(--brand)}
  .dotline::after{content:""; flex:1; width:2px; background:#e5e7eb; margin-top:6px}
  .tl-card{background:#fff;border:1px solid var(--border);padding:10px;border-radius:12px;flex:1}
  /* Modal */
  .modal{position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.35); z-index:50}
  .modal .sheet{width:min(720px,92vw); background:#fff; border-radius:16px; padding:16px; box-shadow:var(--shadow)}
  .modal .grid-2{display:grid; gap:10px; grid-template-columns:1fr 1fr}
  .modal h3{margin:6px 0 10px}
  .modal .actions{display:flex; gap:8px; justify-content:flex-end; margin-top:14px}
  /* Tables mini */
  table{width:100%; border-collapse:collapse}
  th,td{padding:10px; border-bottom:1px solid var(--border); text-align:left; font-size:14px}
  th{color:#6b7280; font-weight:600}
  /* helpers */
  .hidden{display:none !important}
  .hint{font-size:12px;color:var(--muted)}
  .radio-row{display:flex; align-items:center; gap:10px; margin:8px 0}
</style>
</head>
<body>

<!-- Topbar -->
<header class="topbar">
  <div class="logo"><span class="dot"></span> Workspace</div>
  <div class="top-search">
    <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M21 21l-4.35-4.35M10.5 18a7.5 7.5 0 1 1 0-15 7.5 7.5 0 0 1 0 15Z" stroke="#fff" stroke-width="2" stroke-linecap="round"/></svg>
    <input id="searchInput" placeholder="Search employees, tasks, positions…" />
  </div>
  <div class="top-actions">
    <button class="icon-btn" id="importBtn">Import CSV/XLSX</button>
    <input id="fileInput" type="file" accept=".csv,.xlsx,.xls" class="hidden" />
    <button class="icon-btn" id="exportCsvBtn">Export CSV</button>
    <button class="icon-btn" id="addEmployeeBtn">Add Employee</button>
    <button class="icon-btn" id="newTaskBtn">Assign Task</button>
  </div>
</header>

<div class="wrap">
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="side-title">MENU</div>
    <nav class="nav">
      <a class="active" href="#"><span>Home</span></a>
    </nav>

    <div class="side-title" style="margin-top:18px">FILTERS</div>
    <div style="display:flex; flex-direction:column; gap:8px">
      <select id="filterEmployee"></select>
      <select id="filterStatus">
        <option value="">All statuses</option>
        <option>TODO</option>
        <option>IN_PROGRESS</option>
        <option>DONE</option>
        <option>LATE</option>
      </select>
      <input type="date" id="filterDate">
      <button class="btn" id="clearFilters">Clear filters</button>
    </div>
  </aside>

  <!-- Main content -->
  <main class="content">
    <!-- KPI row -->
    <section class="grid grid-4">
      <div class="card stat">
        <div>
          <div class="muted">Employees</div>
          <div class="n" id="kpiEmployees">0</div>
        </div>
        <span class="chip">Active</span>
      </div>
      <div class="card stat">
        <div>
          <div class="muted">Tasks Today</div>
          <div class="n" id="kpiToday">0</div>
        </div>
        <span class="chip warn">Today</span>
      </div>
      <div class="card stat">
        <div>
          <div class="muted">Completed</div>
          <div class="n" id="kpiDone">0</div>
        </div>
        <span class="chip success">On track</span>
      </div>
      <div class="card stat">
        <div>
          <div class="muted">Late</div>
          <div class="n" id="kpiLate">0</div>
        </div>
        <span class="chip danger">Attention</span>
      </div>
    </section>

    <!-- Charts + Positions -->
    <section class="grid grid-3">
      <div class="card">
        <h3>Completion Ratio</h3>
        <canvas id="pieChart" height="200"></canvas>
      </div>
      <div class="card">
        <h3>Tasks by Employee (This Week)</h3>
        <canvas id="barChart" height="200"></canvas>
      </div>
      <div class="card">
        <div class="toolbar">
          <h3 style="margin:0">Open Job Positions</h3>
          <div class="hint">Add, fill/unfill, or delete positions</div>
        </div>
        <!-- Add Opening Row -->
        <div class="grid" style="grid-template-columns:1fr 110px 120px; gap:8px; margin-bottom:10px">
          <input id="posTitle" type="text" placeholder="e.g., Frontend Developer">
          <input id="posOpenings" type="number" min="0" value="1">
          <button class="btn primary" id="addOpeningBtn">Add Opening</button>
        </div>
        <table>
          <thead><tr><th>Position</th><th>Status</th><th>Openings</th><th>Actions</th></tr></thead>
          <tbody id="positionsTbody"></tbody>
        </table>
      </div>
    </section>

    <!-- Employee Board -->
    <section class="card">
      <div class="toolbar">
        <div class="left"><h3 style="margin:0">Employee Task Board</h3></div>
        <div class="right">
          <button class="btn primary" id="assignBtnTop">Assign Task</button>
        </div>
      </div>
      <div id="employeeBoard" class="grid grid-3"></div>
    </section>

    <!-- Timeline -->
    <section class="card">
      <div class="toolbar"><h3 style="margin:0">Activity Timeline</h3></div>
      <div class="timeline" id="timeline"></div>
    </section>
  </main>
</div>

<!-- MODAL: Assign Task -->
<div class="modal" id="taskModal" aria-hidden="true">
  <div class="sheet">
    <h3>Assign a Task</h3>
    <div class="grid grid-2">
      <div>
        <label class="muted">Employee</label>
        <select id="formEmployee" style="width:100%"></select>
      </div>
      <div>
        <label class="muted">Deadline</label>
        <input type="date" id="formDate" style="width:100%">
      </div>
      <div>
        <label class="muted">Title</label>
        <input type="text" id="formTitle" placeholder="e.g., Call shortlisted candidates" style="width:100%">
      </div>
      <div>
        <label class="muted">Priority</label>
        <select id="formPriority" style="width:100%">
          <option>LOW</option><option selected>MEDIUM</option><option>HIGH</option>
        </select>
      </div>
      <div style="grid-column:1/-1">
        <label class="muted">Description</label>
        <textarea id="formDesc" rows="3" placeholder="Optional details…" style="width:100%"></textarea>
      </div>
    </div>
    <div class="actions">
      <button class="btn" id="cancelTask">Cancel</button>
      <button class="btn primary" id="saveTask">Create Task</button>
    </div>
  </div>
</div>

<!-- MODAL: Add Employee -->
<div class="modal" id="empModal" aria-hidden="true">
  <div class="sheet">
    <h3>Add Employee</h3>
    <div class="grid grid-2">
      <div>
        <label class="muted">Full Name</label>
        <input type="text" id="empName" placeholder="e.g., Kavya Iyer" style="width:100%">
      </div>
      <div>
        <label class="muted">Role / Title</label>
        <input type="text" id="empRole" placeholder="e.g., Tech Recruiter" style="width:100%">
      </div>
      <div>
        <label class="muted">Color</label>
        <input type="color" id="empColor" value="#0ea5e9" style="width:100%">
      </div>
    </div>
    <div class="actions">
      <button class="btn" id="cancelEmp">Cancel</button>
      <button class="btn primary" id="saveEmp">Add Employee</button>
    </div>
    <div class="hint">New employees appear immediately in filters, charts, and the board.</div>
  </div>
</div>

<!-- MODAL: Delete Employee -->
<div class="modal" id="delEmpModal" aria-hidden="true">
  <div class="sheet">
    <h3>Delete Employee</h3>
    <div id="delEmpSummary" class="muted" style="margin-bottom:8px"></div>

    <div id="reassignBlock">
      <label class="radio-row">
        <input type="radio" name="delMode" value="reassign" id="modeReassign" checked>
        <span>Reassign all tasks to:</span>
        <select id="reassignTarget"></select>
      </label>
    </div>

    <label class="radio-row">
      <input type="radio" name="delMode" value="deleteTasks" id="modeDelete">
      <span>Delete all tasks of this employee</span>
    </label>

    <div class="actions">
      <button class="btn" id="cancelDelEmp">Cancel</button>
      <button class="btn danger" id="confirmDelEmp">Delete Employee</button>
    </div>
    <div class="hint">This action cannot be undone.</div>
  </div>
</div>

<script>
/* =========================
   In-memory + localStorage
   ========================= */
const LS_KEY = 'workspace-dashboard-v2';

const state = {
  employees: [
    {id:'e1', name:'Anita Desai', role:'HR Recruiter', color:'#10b981'},
    {id:'e2', name:'Ravi Kumar', role:'Talent Sourcer', color:'#6366f1'},
    {id:'e3', name:'Priya Nair', role:'HR Ops', color:'#f97316'},
    {id:'e4', name:'Sanjay Patel', role:'Tech Recruiter', color:'#ef4444'},
    {id:'e5', name:'Neha Shah', role:'Employer Branding', color:'#14b8a6'},
  ],
  positions: [
    {id: crypto.randomUUID(), title:'Sales Manager', status:'Open', openings:3},
    {id: crypto.randomUUID(), title:'Frontend Developer', status:'Open', openings:2},
    {id: crypto.randomUUID(), title:'Account Executive', status:'Closed', openings:0},
    {id: crypto.randomUUID(), title:'Talent Acquisition Intern', status:'Open', openings:1},
  ],
  tasks: [],
  timeline: []
};

function loadLS(){
  const data = JSON.parse(localStorage.getItem(LS_KEY) || '{}');
  if (data.employees) state.employees = data.employees;
  if (data.positions) state.positions = data.positions;
  if (data.tasks) state.tasks = data.tasks;
  if (data.timeline) state.timeline = data.timeline;
}
function saveLS(){
  localStorage.setItem(LS_KEY, JSON.stringify({
    employees: state.employees,
    positions: state.positions,
    tasks: state.tasks,
    timeline: state.timeline
  }));
}

/* ================ */
const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));
const fmtDate = iso => new Date(iso).toLocaleDateString();
const todayISO = () => new Date().toISOString().slice(0,10);
const initials = name => name.split(' ').map(p=>p[0]).slice(0,2).join('').toUpperCase();

function addTimeline(text){
  state.timeline.unshift({id:crypto.randomUUID(), text, ts: new Date().toISOString()});
  saveLS();
  renderTimeline();
}

/* ============
   Date helpers
   ============ */
function weekBounds(date = new Date()){
  // Monday as week start
  const d = new Date(date);
  const day = d.getDay(); // 0 Sun ... 6 Sat
  const diffToMon = (day + 6) % 7;
  const start = new Date(d);
  start.setHours(0,0,0,0);
  start.setDate(d.getDate() - diffToMon);
  const end = new Date(start);
  end.setDate(start.getDate() + 6);
  end.setHours(23,59,59,999);
  return {start, end};
}
function isInCurrentWeek(iso){
  const dt = new Date(iso);
  const {start, end} = weekBounds(new Date());
  return dt >= start && dt <= end;
}

/* =================
   Rendering pieces
   ================= */
let pieChart, barChart;

function renderKpis(){
  $('#kpiEmployees').textContent = state.employees.length;

  const today = todayISO();
  const todayTasks = state.tasks.filter(t => t.dueDate === today);
  $('#kpiToday').textContent = todayTasks.length;

  const done = state.tasks.filter(t => t.status === 'DONE').length;
  $('#kpiDone').textContent = done;

  const late = state.tasks.filter(t => t.status === 'LATE').length;
  $('#kpiLate').textContent = late;
}

function renderPositions(){
  const tbody = $('#positionsTbody');
  tbody.innerHTML = state.positions.map(p => `
    <tr data-id="${p.id}">
      <td>${p.title}</td>
      <td><span class="badge">${p.status}</span></td>
      <td>${p.openings}</td>
      <td style="display:flex; gap:8px">
        <button class="btn small" data-action="toggle-position">${p.status==='Open'?'Mark Filled':'Reopen'}</button>
        <button class="btn small" data-action="delete-position">Delete</button>
      </td>
    </tr>
  `).join('');
}

/* ============================
   Charts (bound to FILTERED data)
   ============================ */
function renderPie(){
  const list = filteredTasks(); // <-- respect filters/search
  const done = list.filter(t=>t.status==='DONE').length;
  const inprog = list.filter(t=>t.status==='IN_PROGRESS').length;
  const todo = list.filter(t=>t.status==='TODO').length;
  const late = list.filter(t=>t.status==='LATE').length;

  const data = {
    labels:['Done','In Progress','To Do','Late'],
    datasets:[{data:[done,inprog,todo,late]}]
  };
  if (pieChart) pieChart.destroy();
  pieChart = new Chart($('#pieChart'),{
    type:'doughnut', data,
    options:{plugins:{legend:{position:'bottom'}}, cutout:'62%'}
  });
}

function tasksByEmployeeThisWeek(){
  const map = new Map();
  state.employees.forEach(e=>map.set(e.id,0));
  const list = filteredTasks().filter(t => isInCurrentWeek(t.dueDate)); // only this week
  list.forEach(t => map.set(t.employeeId,(map.get(t.employeeId)||0)+1));
  return map;
}
function renderBar(){
  const map = tasksByEmployeeThisWeek();
  const labels = state.employees.map(e=>e.name.split(' ')[0]);
  const data = state.employees.map(e=>map.get(e.id)||0);
  if (barChart) barChart.destroy();
  barChart = new Chart($('#barChart'),{
    type:'bar',
    data:{labels,datasets:[{label:'Tasks (This Week)', data}]},
    options:{plugins:{legend:{display:false}}, scales:{y:{ticks:{precision:0}, beginAtZero:true}}}
  });
}

function progressForEmployee(id){
  const list = state.tasks.filter(t=>t.employeeId===id);
  if (!list.length) return 0;
  const done = list.filter(t=>t.status==='DONE').length;
  return Math.round((done/list.length)*100);
}

function filteredTasks(){
  const q = $('#searchInput').value.trim().toLowerCase();
  const emp = $('#filterEmployee').value;
  const status = $('#filterStatus').value;
  const date = $('#filterDate').value;

  return state.tasks.filter(t=>{
    if (emp && t.employeeId !== emp) return false;
    if (status && t.status !== status) return false;
    if (date && t.dueDate !== date) return false;
    if (q){
      const empName = state.employees.find(e=>e.id===t.employeeId)?.name.toLowerCase()||'';
      if (!(t.title.toLowerCase().includes(q) || (t.description||'').toLowerCase().includes(q) || empName.includes(q))) return false;
    }
    return true;
  });
}

function renderBoard(){
  const board = $('#employeeBoard');
  board.innerHTML = state.employees.map(e=>{
    const tasks = filteredTasks().filter(t=>t.employeeId===e.id);
    const prog = progressForEmployee(e.id);
    return `
      <div class="employee-card">
        <div class="emp-head">
          <div class="avatar" style="background:${e.color}">${initials(e.name)}</div>
          <div>
            <div style="font-weight:600">${e.name}</div>
            <div class="muted" style="font-size:12px">${e.role}</div>
          </div>
          <div class="spacer"></div>
          <button class="btn small danger" data-action="delete-emp" data-empid="${e.id}">Delete</button>
        </div>
        <div class="progress-wrap"><div class="progress" style="width:${prog}%"></div></div>
        <div class="muted" style="font-size:12px">${tasks.length} task(s)</div>
        <div class="col-tasks" style="display:flex; flex-direction:column; gap:8px">
          ${tasks.map(t=>taskRow(e, t)).join('')}
        </div>
      </div>
    `;
  }).join('');
}
function taskRow(e,t){
  const due = new Date(t.dueDate);
  const today = new Date(todayISO());
  let status = t.status;
  if (status!=='DONE' && due < today) status = 'LATE';
  return `
    <div class="task-row" data-id="${t.id}">
      <div class="task-meta">
        <input type="checkbox" ${t.status==='DONE'?'checked':''} data-action="toggle-done" />
        <div>
          <div style="font-weight:600">${t.title}</div>
          <div class="muted" style="font-size:12px">${t.description||''}</div>
          <div class="muted" style="font-size:12px">Due: ${fmtDate(t.dueDate)}</div>
        </div>
      </div>
      <div style="display:flex; align-items:center; gap:8px">
        <span class="badge pri-${t.priority}">${t.priority}</span>
        <select class="status-select" data-action="change-status">
          ${['TODO','IN_PROGRESS','DONE','LATE'].map(s=>`<option ${status===s?'selected':''}>${s}</option>`).join('')}
        </select>
        <button class="btn small" data-action="delete">Delete</button>
      </div>
    </div>
  `;
}

function renderTimeline(){
  const box = $('#timeline');
  box.innerHTML = state.timeline.map(ev=>`
    <div class="tl-item">
      <div class="dotline"></div>
      <div class="tl-card">
        <div style="font-size:14px">${ev.text}</div>
        <div class="muted" style="font-size:12px">${new Date(ev.ts).toLocaleString()}</div>
      </div>
    </div>
  `).join('') || '<div class="muted">No activity yet.</div>';
}

function renderFilters(){
  const sel = $('#filterEmployee');
  const formSel = $('#formEmployee');
  const opts = ['<option value="">All employees</option>'].concat(
    state.employees.map(e=>`<option value="${e.id}">${e.name}</option>`)
  ).join('');
  sel.innerHTML = opts;
  formSel.innerHTML = state.employees.map(e=>`<option value="${e.id}">${e.name}</option>`).join('');
}

/* ==================
   Task interactions
   ================== */
function openTaskModal(){ $('#taskModal').style.display='flex'; $('#formDate').value=todayISO(); }
function closeTaskModal(){ $('#taskModal').style.display='none'; }
function openEmpModal(){ $('#empModal').style.display='flex'; }
function closeEmpModal(){ $('#empModal').style.display='none'; clearEmpForm(); }

function createTask(){
  const employeeId = $('#formEmployee').value;
  const title = $('#formTitle').value.trim();
  const description = $('#formDesc').value.trim();
  const dueDate = $('#formDate').value || todayISO();
  const priority = $('#formPriority').value;
  if (!employeeId || !title){ alert('Select employee and enter a title'); return; }

  const emp = state.employees.find(e=>e.id===employeeId);
  const task = {
    id: crypto.randomUUID(),
    employeeId, title, description, dueDate, priority,
    status:'TODO', createdAt: new Date().toISOString(), updatedAt:null
  };
  state.tasks.unshift(task);
  saveLS();
  addTimeline(`Assigned “${title}” to ${emp.name} (due ${fmtDate(dueDate)})`);
  closeTaskModal();
  rerenderAll();
  clearTaskForm();
}
function clearTaskForm(){
  $('#formTitle').value=''; $('#formDesc').value=''; $('#formPriority').value='MEDIUM';
}

function toggleDone(id,checked){
  const t = state.tasks.find(x=>x.id===id); if(!t) return;
  t.status = checked ? 'DONE' : 'TODO';
  t.updatedAt = new Date().toISOString();
  const emp = state.employees.find(e=>e.id===t.employeeId);
  addTimeline(`${emp?.name||'[Unknown]'} marked “${t.title}” as ${t.status}`);
  saveLS(); rerenderAll();
}

function changeStatus(id,value){
  const t = state.tasks.find(x=>x.id===id); if(!t) return;
  t.status = value; t.updatedAt = new Date().toISOString();
  const emp = state.employees.find(e=>e.id===t.employeeId);
  addTimeline(`${emp?.name||'[Unknown]'} status changed for “${t.title}” → ${value}`);
  saveLS(); rerenderAll();
}

function deleteTask(id){
  const t = state.tasks.find(x=>x.id===id);
  if (!t) return;
  const emp = state.employees.find(e=>e.id===t.employeeId);
  if (confirm('Delete this task?')){
    state.tasks = state.tasks.filter(x=>x.id!==id);
    saveLS();
    addTimeline(`Deleted task “${t.title}” from ${emp?.name||'[Unknown]'}`);
    rerenderAll();
  }
}

/* ======================
   Positions interactions
   ====================== */
function addOpening(){
  const title = $('#posTitle').value.trim();
  const openings = parseInt($('#posOpenings').value,10);
  if (!title){ alert('Enter a position title'); return; }
  if (isNaN(openings) || openings < 0){ alert('Openings must be 0 or more'); return; }
  const rec = {id:crypto.randomUUID(), title, status: openings>0 ? 'Open' : 'Closed', openings};
  state.positions.unshift(rec);
  saveLS();
  addTimeline(`Opening added: ${title} (${openings})`);
  $('#posTitle').value=''; $('#posOpenings').value=1;
  renderPositions();
}
function togglePosition(id){
  const p = state.positions.find(x=>x.id===id); if(!p) return;
  if (p.status==='Open'){ p.status='Closed'; p.openings=0; addTimeline(`Marked position filled: ${p.title}`); }
  else { p.status='Open'; p.openings=1; addTimeline(`Reopened position: ${p.title}`); }
  saveLS(); renderPositions();
}
function deletePosition(id){
  const p = state.positions.find(x=>x.id===id); if(!p) return;
  if (confirm(`Delete position "${p.title}"?`)){
    state.positions = state.positions.filter(x=>x.id!==id);
    saveLS(); addTimeline(`Deleted position: ${p.title}`); renderPositions();
  }
}

/* =====================
   Employees interactions
   ===================== */
function clearEmpForm(){ $('#empName').value=''; $('#empRole').value=''; $('#empColor').value='#0ea5e9'; }

function createEmployee(){
  const name = $('#empName').value.trim();
  const role = $('#empRole').value.trim() || 'Staff';
  const color = $('#empColor').value || '#0ea5e9';
  if (!name){ alert('Enter full name'); return; }
  const id = 'e' + Math.random().toString(36).slice(2,8);
  state.employees.push({id, name, role, color});
  saveLS();
  addTimeline(`New employee added: ${name} (${role})`);
  renderFilters();
  rerenderAll();
  closeEmpModal();
}

/* ===== Delete Employee flow ===== */
let DEL_EMP_ID = null;

function openDeleteEmpModal(empId){
  DEL_EMP_ID = empId;
  const emp = state.employees.find(e=>e.id===empId);
  const tasksCount = state.tasks.filter(t=>t.employeeId===empId).length;

  $('#delEmpSummary').textContent =
    `Remove ${emp.name}? They currently have ${tasksCount} task(s).`;

  const others = state.employees.filter(e=>e.id!==empId);
  const select = $('#reassignTarget');
  select.innerHTML = others.map(o=>`<option value="${o.id}">${o.name}</option>`).join('');

  if (others.length === 0){
    $('#reassignBlock').classList.add('hidden');
    $('#modeDelete').checked = true;
  }else{
    $('#reassignBlock').classList.remove('hidden');
    $('#modeReassign').checked = true;
  }

  $('#delEmpModal').style.display='flex';
}

function closeDeleteEmpModal(){
  $('#delEmpModal').style.display='none';
  DEL_EMP_ID = null;
}

function confirmDeleteEmployee(){
  if (!DEL_EMP_ID) return;
  const emp = state.employees.find(e=>e.id===DEL_EMP_ID);
  const mode = document.querySelector('input[name="delMode"]:checked')?.value;

  let affected = state.tasks.filter(t=>t.employeeId===DEL_EMP_ID).length;

  if (mode === 'reassign'){
    const target = $('#reassignTarget').value;
    if (!target){ alert('Select a reassignment target'); return; }
    state.tasks.forEach(t=>{ if (t.employeeId===DEL_EMP_ID) t.employeeId = target; });
    const toEmp = state.employees.find(e=>e.id===target);
    addTimeline(`Reassigned ${affected} task(s) from ${emp.name} to ${toEmp.name}.`);
  }else{
    state.tasks = state.tasks.filter(t=>t.employeeId!==DEL_EMP_ID);
    addTimeline(`Deleted ${affected} task(s) belonging to ${emp.name}.`);
  }

  state.employees = state.employees.filter(e=>e.id!==DEL_EMP_ID);
  saveLS();
  addTimeline(`Removed employee: ${emp.name}`);
  closeDeleteEmpModal();

  if ($('#filterEmployee').value === DEL_EMP_ID){ $('#filterEmployee').value = ''; }

  rerenderAll();
}

/* =========== CSV/Excel Export =========== */
function exportCsv(){
  const rows = [
    ['Task ID','Employee','Title','Description','Due Date','Priority','Status','Created At','Updated At']
  ];
  state.tasks.forEach(t=>{
    const emp = state.employees.find(e=>e.id===t.employeeId)?.name || '';
    rows.push([t.id, emp, t.title, (t.description||'').replace(/[\n\r]+/g,' '), t.dueDate, t.priority, t.status, t.createdAt, t.updatedAt||'']);
  });
  const csv = rows.map(r=>r.map(field=>{
    const s = String(field).replace(/"/g,'""'); return `"${s}"`;
  }).join(',')).join('\n');

  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `workspace-tasks-${Date.now()}.csv`;
  a.click();
  URL.revokeObjectURL(a.href);
}

/* ============== CSV/XLSX Import ============== */
function normalizeDate(val){
  if (!val) return todayISO();
  // Excel serial number
  if (typeof val === 'number'){
    const epoch = new Date(Math.round((val - 25569) * 86400000)); // 25569 = Excel epoch
    const d = new Date(epoch.getFullYear(), epoch.getMonth(), epoch.getDate());
    return d.toISOString().slice(0,10);
  }
  const s = String(val).trim();
  // already YYYY-MM-DD
  if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;
  const d = new Date(s);
  if (!isNaN(d.getTime())) return new Date(d.getFullYear(), d.getMonth(), d.getDate()).toISOString().slice(0,10);
  return todayISO();
}
function randColor(){
  return '#'+Math.floor(Math.random()*0xffffff).toString(16).padStart(6,'0');
}
function upsertEmployeeByName(name, roleGuess){
  if (!name) return null;
  const needle = name.trim().toLowerCase();
  let emp = state.employees.find(e=>e.name.trim().toLowerCase()===needle);
  if (!emp){
    const id = 'e' + Math.random().toString(36).slice(2,8);
    emp = {id, name:name.trim(), role: roleGuess || 'Staff', color: randColor()};
    state.employees.push(emp);
  }
  return emp;
}
function importRows(rows){
  let added = 0;
  rows.forEach(rec=>{
    if (!rec) return;
    // Case-insensitive keys
    const obj = {};
    Object.keys(rec).forEach(k=>{ obj[k.trim().toLowerCase()] = rec[k]; });

    const empName = obj['employee'] || obj['emp'] || obj['assignee'];
    if (!empName) return;

    const emp = upsertEmployeeByName(String(empName), obj['role']);
    if (!emp) return;

    const title = (obj['title']||'').toString().trim() || 'Untitled Task';
    const description = (obj['description']||'').toString();
    const dueDate = normalizeDate(obj['duedate'] || obj['due'] || obj['deadline']);
    const priority = (obj['priority']||'MEDIUM').toString().toUpperCase();
    const status = (obj['status']||'TODO').toString().toUpperCase();

    state.tasks.push({
      id: crypto.randomUUID(),
      employeeId: emp.id,
      title, description, dueDate, priority, status,
      createdAt: new Date().toISOString(), updatedAt: null
    });
    added++;
  });
  if (added>0){
    saveLS();
    addTimeline(`Imported ${added} record(s) from file.`);
    renderFilters();
    rerenderAll();
  }else{
    alert('No valid rows found to import.');
  }
}
function importFile(file){
  const ext = file.name.split('.').pop().toLowerCase();
  const reader = new FileReader();
  if (ext === 'csv'){
    reader.onload = e=>{
      const text = e.target.result;
      // Let SheetJS parse CSV robustly
      const wb = XLSX.read(text, {type:'string'});
      const ws = wb.Sheets[wb.SheetNames[0]];
      const rows = XLSX.utils.sheet_to_json(ws, {defval:''});
      importRows(rows);
    };
    reader.readAsText(file);
  }else{
    // .xlsx / .xls
    reader.onload = e=>{
      const data = new Uint8Array(e.target.result);
      const wb = XLSX.read(data, {type:'array', cellDates:true});
      const ws = wb.Sheets[wb.SheetNames[0]];
      const rows = XLSX.utils.sheet_to_json(ws, {defval:''});
      importRows(rows);
    };
    reader.readAsArrayBuffer(file);
  }
}

/* ==========
   Rerender
   ========== */
function rerenderAll(){
  renderKpis();
  renderPositions();
  renderBoard();
  renderPie();
  renderBar();
  renderFilters();
}

/* ==========
   Seed demo
   ========== */
function seedIfEmpty(){
  if (state.tasks.length) return;
  const seed = [
    {emp:'e1', title:'Call 5 shortlisted candidates', due:+1, pri:'HIGH'},
    {emp:'e2', title:'Source 10 resumes for FE Dev', due:+0, pri:'MEDIUM'},
    {emp:'e3', title:'Schedule interview with Sales lead', due:+0, pri:'LOW'},
    {emp:'e4', title:'Screening: Backend role', due:+2, pri:'MEDIUM'},
    {emp:'e2', title:'Publish JD on portals', due:-1, pri:'HIGH'},
  ];
  seed.forEach(s=>{
    state.tasks.push({
      id:crypto.randomUUID(),
      employeeId:s.emp,
      title:s.title,
      description:'',
      dueDate:new Date(Date.now()+s.due*86400000).toISOString().slice(0,10),
      priority:s.pri, status: s.due<0 ? 'LATE' : 'TODO',
      createdAt:new Date().toISOString(),
      updatedAt:null
    })
  });
  addTimeline('Loaded sample tasks.');
  saveLS();
}

/* ==========
   Events
   ========== */
document.addEventListener('click', e=>{
  // Task row actions
  const row = e.target.closest('.task-row');
  if (row){
    const id = row.dataset.id;
    if (e.target.matches('[data-action="delete"]')) deleteTask(id);
    if (e.target.matches('[data-action="toggle-done"]')) toggleDone(id, e.target.checked);
  }
  if (e.target.matches('[data-action="change-status"]')){
    const id = e.target.closest('.task-row').dataset.id;
    changeStatus(id, e.target.value);
  }

  // Position actions
  const prow = e.target.closest('tr[data-id]');
  if (prow){
    const pid = prow.dataset.id;
    if (e.target.matches('[data-action="toggle-position"]')) togglePosition(pid);
    if (e.target.matches('[data-action="delete-position"]')) deletePosition(pid);
  }

  // Employee delete
  const delBtn = e.target.closest('button[data-action="delete-emp"]');
  if (delBtn){
    openDeleteEmpModal(delBtn.dataset.empid);
  }
});

// Top buttons
$('#newTaskBtn').onclick = openTaskModal;
$('#assignBtnTop').onclick = openTaskModal;
$('#cancelTask').onclick = closeTaskModal;
$('#saveTask').onclick = createTask;
$('#exportCsvBtn').onclick = exportCsv;

// Import buttons
$('#importBtn').onclick = ()=> $('#fileInput').click();
$('#fileInput').addEventListener('change', (e)=>{
  const file = e.target.files?.[0];
  if (file) importFile(file);
  e.target.value = ''; // reset for next import
});

// Add employee
$('#addEmployeeBtn').onclick = openEmpModal;
$('#cancelEmp').onclick = closeEmpModal;
$('#saveEmp').onclick = createEmployee;

// Positions add
$('#addOpeningBtn').onclick = addOpening;

// Delete employee modal
$('#cancelDelEmp').onclick = closeDeleteEmpModal;
$('#confirmDelEmp').onclick = confirmDeleteEmployee;

// Filters — now refresh EVERYTHING so charts reflect filters
$('#searchInput').addEventListener('input', ()=>rerenderAll());
$('#filterEmployee').addEventListener('change', ()=>rerenderAll());
$('#filterStatus').addEventListener('change', ()=>rerenderAll());
$('#filterDate').addEventListener('change', ()=>rerenderAll());
$('#clearFilters').onclick = ()=>{
  $('#searchInput').value = '';
  $('#filterEmployee').value = '';
  $('#filterStatus').value = '';
  $('#filterDate').value = '';
  rerenderAll();
};

/* ==========
   Boot
   ========== */
function init(){
  loadLS();
  renderFilters();
  seedIfEmpty();
  rerenderAll();
  renderTimeline();
}
init();
</script>
</body>
</html>
